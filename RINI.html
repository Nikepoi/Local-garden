<!doctype html>
<html lang="en-US">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Custom Video Player — Mobile (modal + blur)</title>
<link rel="icon" href="favicon.ico">
<style>
:root{
  --bg:#0f0f0f;
  --panel:#181818;
  --border:#232323;
  --muted:#9ea8b4;
  --text:#ffffff;
  --accent:#ff0000;
  --accent-2:#3ea6ff;
  --control-h:56px;
  --round:10px;
  --active-yellow:#ffd54f;
}

/* Base */
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter, Roboto, Arial, sans-serif;-webkit-font-smoothing:antialiased}
a{color:inherit}
.wrap{max-width:980px;margin:0 auto;padding:0 12px}

/* Cinema mode: full dark blur background, player lebih besar */
body.cinema-mode {
  background:#000 !important;
  -webkit-backdrop-filter: blur(20px);
  backdrop-filter: blur(20px);
}
body.cinema-mode .wrap { padding:0; max-width:100%; }
body.cinema-mode .card-player { margin:0; border-radius:0; height:100vh; display:flex; flex-direction:column; justify-content:center; background:transparent; }
body.cinema-mode .video-area { max-height:90vh; border-radius:0; }
body.cinema-mode video { max-height:90vh; object-fit:contain; }

/* Player card */
.card-player{margin-top:10px;border-radius:8px;overflow:hidden}
.video-area{position:relative;background:#000;border-radius:8px;overflow:hidden}
video{width:100%;height:auto;display:block;background:#000;object-fit:contain}

/* Center big play */
.center-play{
  position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
  width:68px;height:68px;border-radius:999px;display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.55);border:1px solid rgba(255,255,255,0.05);z-index:40;cursor:pointer;-webkit-tap-highlight-color:transparent;
  transition:transform 200ms cubic-bezier(.2,.9,.2,1), opacity 160ms ease;
}
.center-play svg{width:30px;height:30px;fill:var(--text)}
.center-play:active{transform:translate(-50%,-50%) scale(.96)}

/* loading overlay */
.loading-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:45;pointer-events:none}
.loading-box{display:flex;gap:12px;align-items:center;padding:10px 12px;border-radius:12px;background:rgba(0,0,0,0.55);border:1px solid rgba(255,255,255,0.04)}
.loading-spinner{width:28px;height:28px;border-radius:50%;border:3px solid rgba(255,255,255,0.06);border-top-color:var(--accent);animation:spin .9s linear infinite}

/* meta */
.top-meta{padding:10px 6px;display:flex;align-items:center;gap:8px;justify-content:space-between}
.title-wrap{display:flex;flex-direction:column;gap:6px}
.title{font-size:16px;font-weight:700;margin:0;line-height:1.2}
.date{font-size:13px;color:var(--muted);margin-top:0}
.part-badge{font-size:13px;color:var(--text);background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.03)}

/* controls */
.controls{background:var(--panel);border-top:1px solid var(--border);padding:10px 8px;display:flex;flex-direction:column;gap:8px;border-radius:0 0 8px 8px}
.seek-row{display:flex;align-items:center;gap:8px}
.time{width:54px;font-size:12px;color:var(--muted);text-align:center}
.seek{flex:1;-webkit-appearance:none;background:transparent;height:6px;position:relative}
.seek::-webkit-slider-runnable-track{height:6px;background:#333;border-radius:6px}
.seek::-webkit-slider-thumb{appearance:none;width:12px;height:12px;border-radius:50%;background:var(--accent);margin-top:-3px;box-shadow:0 0 0 6px rgba(255,0,0,0.06)}
.seek::-moz-range-track{height:6px;background:#333;border-radius:6px}
.seek::-moz-range-thumb{width:12px;height:12px;border-radius:50%;background:var(--accent)}

/* control row */
.control-row{display:flex;align-items:center;gap:8px;height:var(--control-h)}
.left{display:flex;align-items:center;gap:6px}
.right{margin-left:auto;display:flex;align-items:center;gap:6px}

/* buttons with active state */
.btn{background:transparent;border:none;color:var(--text);padding:8px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;position:relative}
.btn:active{transform:scale(0.98)}
.btn svg{width:22px;height:22px;display:block;fill:var(--text)}
.btn.active { background:rgba(255,213,79,0.12); border:1px solid rgba(255,213,79,0.3); box-shadow:0 0 12px rgba(255,213,79,0.2); }
.btn.active svg { fill:var(--active-yellow); }
.btn-play{width:44px;height:44px;background:linear-gradient(90deg,var(--accent-2),var(--accent));border-radius:8px;display:flex;align-items:center;justify-content:center}
.btn-play svg{width:18px;height:18px;fill:#fff}

/* Tooltip hint untuk download (visible di desktop/hover) */
.btn[title]:hover::after,
.btn[title]:focus::after {
  content: attr(title);
  position:absolute; bottom:100%; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,0.85); color:#fff; padding:4px 8px; border-radius:6px;
  font-size:12px; white-space:nowrap; z-index:50; pointer-events:none;
}

/* small select */
.select{background:transparent;border:1px solid var(--border);color:var(--text);padding:6px;border-radius:8px;font-size:13px}

/* downloads area */
.downloads{padding:10px 6px;background:var(--panel);border-top:1px solid var(--border)}
.heading{font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:8px;justify-content:center}

/* full action - improved contrast */
.full-action{
  display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;
  background:linear-gradient(90deg, rgba(255,213,79,0.24), rgba(255,235,166,0.14));
  border:1px solid rgba(255,213,79,0.35);
  color:#ffffff;font-weight:800;cursor:pointer;
  transition:transform 160ms cubic-bezier(.2,.9,.2,1), box-shadow 160ms ease;
  text-shadow:0 1px 3px rgba(0,0,0,0.6);
}
.full-action:active{transform:scale(.98)}
.full-action svg{width:16px;height:16px;fill:var(--active-yellow)}

/* modal overlay */
.full-modal{
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:1000;
  background:rgba(0,0,0,0.75);
  -webkit-backdrop-filter: blur(12px);
  backdrop-filter: blur(12px);
  opacity:0;pointer-events:none;transition:opacity 220ms ease;
}
.full-modal.show{opacity:1;pointer-events:auto}

/* modal panel */
.full-modal-panel{
  width:92%;
  max-width:420px;
  background:rgba(30,30,30,0.95);
  border-radius:12px;padding:16px;
  border:1px solid rgba(255,255,255,0.08);
  box-shadow:0 20px 50px rgba(0,0,0,0.7);
  transform:translateY(12px) scale(.98);opacity:0;
  transition:transform 240ms cubic-bezier(.2,.9,.2,1),opacity 200ms ease;
}
.full-modal.show .full-modal-panel{transform:translateY(0) scale(1);opacity:1}

/* panel header */
.modal-header{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:12px}
.modal-title{font-weight:800;color:var(--text)}
.modal-close{background:transparent;border:none;padding:8px;border-radius:8px;cursor:pointer}
.modal-close svg{width:18px;height:18px;fill:var(--text)}

/* modal list */
.modal-list{display:flex;flex-direction:column;gap:8px;margin-top:6px}
.modal-item{
  display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;
  background:linear-gradient(90deg, rgba(255,213,79,0.12), rgba(255,213,79,0.06));
  border:1px solid rgba(255,213,79,0.25);
  font-weight:700;color:#000;text-decoration:none;
}
.modal-item a{color:inherit;text-decoration:none;flex:1}

/* small note */
.modal-note{font-size:13px;color:var(--muted);margin-top:12px}

/* parts grid */
.parts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-top:8px}
.part-item{padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent;font-weight:600;color:var(--text);text-decoration:none;display:inline-flex;align-items:center;gap:8px;justify-content:center}
.part-item.active{background:linear-gradient(90deg, rgba(255,213,79,0.12), rgba(255,235,166,0.04));border-color: rgba(255,213,79,0.28);box-shadow:0 8px 24px rgba(255,213,79,0.06)}
.part-item:focus{outline:2px solid rgba(255,213,79,0.12);outline-offset:2px}

/* dot animation */
.part-item .dot{width:10px;height:10px;border-radius:50%;background:transparent;border:1px solid rgba(255,255,255,0.06)}
.part-item.active .dot{background:var(--active-yellow);border-color:var(--active-yellow);box-shadow:0 6px 18px rgba(255,213,79,0.14);animation:pop 420ms cubic-bezier(.2,.9,.2,1)}

/* center section title */
.downloads .section-title { text-align:center; font-weight:700; margin-top:12px; }

/* toast */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(0,0,0,0.8);color:var(--text);padding:10px 14px;border-radius:10px;display:none;font-size:13px;z-index:60}

/* accessibility */
button:focus, .download-btn:focus, .part-item:focus, select:focus, .full-action:focus, .modal-close:focus{outline:2px solid rgba(255,255,255,0.06);outline-offset:2px}

@media(min-width:720px){ .wrap{max-width:980px;padding:12px} video{max-height:60vh} }
@keyframes spin{ to { transform: rotate(360deg); } }
@keyframes pop{0%{transform:scale(.6);opacity:0}60%{transform:scale(1.12);opacity:1}100%{transform:scale(1)}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card-player" id="card">
      <div class="video-area" id="videoArea" aria-label="Video area">
        <video id="video" playsinline webkit-playsinline preload="metadata" tabindex="0"></video>

        <button id="centerPlay" class="center-play" aria-label="Play">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
        </button>

        <div id="loading" class="loading-overlay" style="display:none;pointer-events:none" aria-hidden="true">
          <div class="loading-box" role="status" aria-live="polite">
            <div class="loading-spinner" aria-hidden="true"></div>
            <div>
              <div style="font-weight:700;font-size:14px">Memuat video…</div>
              <div style="color:var(--muted);font-size:13px">Menunggu jaringan / buffering</div>
            </div>
          </div>
        </div>
      </div>

      <div class="top-meta">
        <div class="title-wrap">
          <div id="title" class="title">Judul Video</div>
          <div id="date" class="date"></div>
        </div>
        <div id="partBadge" class="part-badge" aria-live="polite">Video 1 / 1</div>
      </div>

      <div class="controls" role="region" aria-label="Kontrol pemutar">
        <div class="seek-row">
          <div id="current" class="time">0:00</div>
          <input id="seek" class="seek" type="range" min="0" max="100" step="0.01" value="0" aria-label="Seek bar">
          <div id="duration" class="time">0:00</div>
        </div>

        <div class="control-row" aria-hidden="false">
          <div class="left" role="group" aria-label="Main controls">
            <button id="prev" class="btn" title="Previous part" aria-label="Previous">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 6h2v12H6zm3 6l9 6V6z"/></svg>
            </button>

            <button id="play" class="btn-play" title="Play/Pause" aria-label="Play/Pause">
              <svg id="playIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
            </button>

            <button id="next" class="btn" title="Next part" aria-label="Next">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 6h2v12h-2zM6 18l9-6-9-6z"/></svg>
            </button>

            <button id="loop" class="btn" title="Loop (toggle)" aria-pressed="false" aria-label="Loop">Loop</button>

            <button id="dl" class="btn" title="Download this part" aria-label="Download">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 16l4-5h-3V4h-2v7H8zM4 18h16v2H4z"/></svg>
            </button>

            <!-- New: Cinema mode toggle -->
            <button id="cinema" class="btn" title="Cinema mode (full dark blur)" aria-label="Cinema mode" aria-pressed="false">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"/></svg>
            </button>
          </div>

          <div class="right">
            <select id="speed" class="select" aria-label="Playback speed">
              <option value="0.5">0.5x</option>
              <option value="0.75">0.75x</option>
              <option value="1" selected>1x</option>
              <option value="1.25">1.25x</option>
              <option value="1.5">1.5x</option>
              <option value="2">2x</option>
            </select>

            <button id="pip" class="btn" title="Picture-in-Picture" aria-label="Picture in picture">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M19 7H5v10h14V7zm0-2a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h14zM7 9h6v4H7z"/></svg>
            </button>

            <button id="fs" class="btn" title="Fullscreen" aria-label="Fullscreen">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 14H5v5h5v-2H7zm0-4h2V7h3V5H5v5zm10 9h-3v2h5v-5h-2zm-3-14v2h3v3h2V5z"/></svg>
            </button>
          </div>
        </div>
      </div>

      <div class="downloads" aria-label="video player">
        <div class="heading">
          <button id="fullActionBtn" class="full-action" aria-haspopup="dialog" aria-expanded="false" title="Buka konten full">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3l4 4h-3v7h-2V7H8l4-4zm9 14v4H3v-4H1v6a2 2 0 002 2h18a2 2 0 002-2v-6h-2z"/></svg>
            <span style="color:var(--text);margin-left:6px">Buka konten full</span>
          </button>
        </div>

        <div class="section-title">video ( urutan nonton )</div>
        <div id="partsGrid" class="parts-grid" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <!-- Modal full konten -->
  <div id="fullModal" class="full-modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="full-modal-panel" role="document" aria-labelledby="fullModalTitle">
      <div class="modal-header">
        <div id="fullModalTitle" class="modal-title">Pilih Konten Full</div>
        <button id="fullModalClose" class="modal-close" aria-label="Tutup">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7a1 1 0 0 0-1.41 1.41L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.9a1 1 0 0 0 1.41-1.41L13.41 12l4.9-4.89a1 1 0 0 0 0-1.4z"/></svg>
        </button>
      </div>

      <div id="fullModalList" class="modal-list" role="menu" aria-labelledby="fullModalTitle">
        <!-- injected links -->
      </div>

      <div class="modal-note">Pilih salah satu sumber untuk membuka konten full.</div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* DATA sama */
const videos = [
  "https://cdn.vipoy.co/videos/cmkunk30a01mzseksx2oy19il/1769445408126-1000098857.mp4",
  "https://cdn.vipoy.co/videos/cmkunk30a01mzseksx2oy19il/1769445041400-1000099491.mp4",
  "https://cdn.vipoy.co/videos/cmkunk30a01mzseksx2oy19il/1769445587141-1000098654.mp4",
  "https://cdn.vipoy.co/videos/cmkunk30a01mzseksx2oy19il/1769445543114-1000098660.mp4",
  "https://cdn.vipoy.co/videos/cmkunk30a01mzseksx2oy19il/1769445467259-1000098667.mp4",
  "https://cdn.vipoy.co/videos/cmkunk30a01mzseksx2oy19il/1769445293226-1000099080.mp4",
  "https://cdn.vipoy.co/videos/cmkunk30a01mzseksx2oy19il/1769445230849-1000099292.mp4",
  "https://cdn.vipoy.co/videos/cmkunk30a01mzseksx2oy19il/1769445208260-1000099332.mp4",
  "https://cdn.vipoy.co/videos/cmkunk30a01mzseksx2oy19il/1769445122943-1000099386.mp4"
];

const partsDownloadLinks = [
  "https://vipoy.co/view/k10pepch",
  "https://vipoy.co/view/czu1oxm1",
  "https://vipoy.co/view/a2h5t352",
  "https://vipoy.co/view/1fs8ojba",
  "https://vipoy.co/view/nfda2171",
  "https://vipoy.co/view/12eo8y55",
  "https://vipoy.co/view/uoqmpjnh",
  "https://vipoy.co/view/tdykl7x6",
  "https://vipoy.co/view/phslcvzl"
];

const downloads = {
  uc: "https://uc-share.com/s/c274d9a2762f4?la=en-us",
  terabox: "https://1024terabox.com/s/1gcGs04775L7mTUFhQ1_RWw"
};

/* DOM refs */
const video = document.getElementById('video');
const centerPlay = document.getElementById('centerPlay');
const loading = document.getElementById('loading');
const playBtn = document.getElementById('play');
const prevBtn = document.getElementById('prev');
const nextBtn = document.getElementById('next');
const loopBtn = document.getElementById('loop');
const dlBtn = document.getElementById('dl');
const cinemaBtn = document.getElementById('cinema');
const speedSel = document.getElementById('speed');
const seek = document.getElementById('seek');
const currentT = document.getElementById('current');
const durationT = document.getElementById('duration');
const titleEl = document.getElementById('title');
const partsGrid = document.getElementById('partsGrid');
const toast = document.getElementById('toast');
const fullActionBtn = document.getElementById('fullActionBtn');
const fullModal = document.getElementById('fullModal');
const fullModalList = document.getElementById('fullModalList');
const fullModalClose = document.getElementById('fullModalClose');
const partBadge = document.getElementById('partBadge');

let idx = 0;
let isSeeking = false;
const STORAGE_KEY = 'custom_video_player_state_v1';
let lastSaveAt = 0;

function fmt(s){ if(!isFinite(s)) return "0:00"; const sec = Math.floor(s%60).toString().padStart(2,'0'); const min = Math.floor(s/60); return `\( {min}: \){sec}`; }
function showLoading(){ loading.style.display = ''; loading.setAttribute('aria-hidden','false'); }
function hideLoading(){ loading.style.display = 'none'; loading.setAttribute('aria-hidden','true'); updateCenterPlay(); }
function showToast(msg, time = 4000){ toast.textContent = msg; toast.style.display = 'block'; setTimeout(()=> toast.style.display = 'none', time); }
function clampIndex(i){ if(!videos.length) return 0; return ((i % videos.length) + videos.length) % videos.length; }
function loadSavedState(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return null; const obj = JSON.parse(raw); if(typeof obj === 'object' && Number.isFinite(obj.idx)) return obj; return null; }catch(e){ return null; } }
function saveStateImmediate(){ try{ const state = { idx: idx, time: Math.floor(video.currentTime || 0) }; localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); lastSaveAt = Date.now(); }catch(e){} }
function saveStateThrottled(){ const now = Date.now(); if(now - lastSaveAt > 2000){ saveStateImmediate(); } }

function setSourceNoAuto(src){
  try{ video.pause(); }catch(e){}
  video.removeAttribute('src');
  video.src = src;
  try{ video.load(); }catch(e){}
  showLoading();
  updatePartBadge();
  updatePartsHighlight();
  saveStateImmediate();
}

const savedState = loadSavedState();
if(savedState && Number.isFinite(savedState.idx) && savedState.idx >= 0 && savedState.idx < videos.length){
  idx = clampIndex(savedState.idx);
} else {
  idx = 0;
}
if(videos.length) setSourceNoAuto(videos[idx]);

/* Events */
video.addEventListener('loadedmetadata', () => {
  durationT.textContent = fmt(video.duration || 0);
  seek.max = video.duration || 100;
  try{
    const s = loadSavedState();
    if(s && Number.isFinite(s.idx) && s.idx === idx && Number.isFinite(s.time) && s.time > 0 && s.time < (video.duration - 0.5)){
      setTimeout(()=> { try{ video.currentTime = Number(s.time); }catch(e){} }, 50);
    }
  }catch(e){}
});

video.addEventListener('canplay', () => { hideLoading(); });

video.addEventListener('playing', () => {
  hideLoading();
  playBtn.querySelector('svg').innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
  centerPlay.style.display = 'none';
});

['waiting','stalled'].forEach(ev => video.addEventListener(ev, () => { showLoading(); }));

video.addEventListener('timeupdate', () => {
  if(!isSeeking){ seek.value = video.currentTime; currentT.textContent = fmt(video.currentTime); }
  saveStateThrottled();
});

seek.addEventListener('input', ()=> { isSeeking = true; currentT.textContent = fmt(seek.value); });
seek.addEventListener('change', ()=> { video.currentTime = Number(seek.value); isSeeking = false; });

async function togglePlay(){
  try {
    if(video.paused){
      await video.play();
      playBtn.querySelector('svg').innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
      centerPlay.style.display = 'none';
    } else {
      video.pause();
      playBtn.querySelector('svg').innerHTML = '<path d="M8 5v14l11-7z"/>';
      centerPlay.style.display = '';
    }
  } catch(e){
    showToast('Gagal memutar video. Coba lagi atau lanjut ke bagian berikutnya.');
    console.warn('Play failed', e);
  }
}

playBtn.addEventListener('click', togglePlay);
centerPlay.addEventListener('click', (e)=>{ e.stopPropagation(); togglePlay(); });
video.addEventListener('click', togglePlay);
video.addEventListener('pause', ()=> { playBtn.querySelector('svg').innerHTML = '<path d="M8 5v14l11-7z"/>'; centerPlay.style.display = ''; });
function updateCenterPlay(){ centerPlay.style.display = video.paused ? '' : 'none'; }

prevBtn.addEventListener('click', ()=> {
  if(!videos.length){ showToast('Tidak ada bagian sebelumnya.'); return; }
  idx = clampIndex(idx - 1);
  setSourceNoAuto(videos[idx]);
});
nextBtn.addEventListener('click', ()=> {
  if(!videos.length){ showToast('Tidak ada bagian berikutnya.'); return; }
  idx = clampIndex(idx + 1);
  setSourceNoAuto(videos[idx]);
});

loopBtn.addEventListener('click', ()=> {
  video.loop = !video.loop;
  loopBtn.setAttribute('aria-pressed', String(video.loop));
  loopBtn.classList.toggle('active', video.loop);
});

speedSel.addEventListener('change', ()=> { video.playbackRate = Number(speedSel.value); });

document.getElementById('fs')?.addEventListener('click', ()=> {
  const el = document.querySelector('.video-area');
  if(!document.fullscreenElement) el.requestFullscreen().catch(()=>{});
  else document.exitFullscreen();
});

document.getElementById('pip')?.addEventListener('click', async ()=>{
  if('pictureInPictureEnabled' in document){
    try{
      if(document.pictureInPictureElement) await document.exitPictureInPicture();
      else await video.requestPictureInPicture();
    }catch(e){ console.warn('PIP failed', e); }
  }
});

/* Cinema mode toggle */
cinemaBtn.addEventListener('click', ()=> {
  document.body.classList.toggle('cinema-mode');
  cinemaBtn.setAttribute('aria-pressed', document.body.classList.contains('cinema-mode'));
  cinemaBtn.classList.toggle('active', document.body.classList.contains('cinema-mode'));
  showToast(document.body.classList.contains('cinema-mode') ? 'Cinema mode ON' : 'Cinema mode OFF', 2000);
});

video.addEventListener('ended', ()=> {
  if(video.loop) return;
  if(videos.length && idx < videos.length - 1){ idx++; setSourceNoAuto(videos[idx]); }
});

video.addEventListener('error', (e) => {
  const failedSrc = video.currentSrc || video.src || 'unknown';
  console.warn('Video error at index', idx, failedSrc, e);
  hideLoading();
  showToast(`Error memuat video bagian ${idx+1}. Melewati ke berikutnya...`, 5000);

  const pos = videos.indexOf(failedSrc);
  if(pos !== -1){
    videos.splice(pos,1);
    if(partsDownloadLinks[pos]) partsDownloadLinks.splice(pos,1);
    if(pos <= idx) idx = Math.max(0, idx - 1);
  }

  if(videos.length){
    idx = clampIndex(idx);
    setTimeout(()=> setSourceNoAuto(videos[idx]), 300);
    buildPartsGrid();
  } else {
    showToast('Semua sumber video gagal dimuat.');
    try{ video.removeAttribute('src'); video.load(); }catch(e){}
    buildPartsGrid();
  }
});

window.addEventListener('keydown', (e)=> {
  if(['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
  if(e.code === 'Space'){ e.preventDefault(); togglePlay(); }
  if(e.code === 'ArrowLeft'){ video.currentTime = Math.max(0, video.currentTime - 5); }
  if(e.code === 'ArrowRight'){ video.currentTime = Math.min(video.duration || 0, video.currentTime + 5); }
  if(e.key === 'm'){ video.muted = !video.muted; }
  if(e.key.toLowerCase() === 'c'){ // shortcut C untuk cinema mode
    cinemaBtn.click();
  }
});

document.addEventListener('contextmenu', e => e.preventDefault());

function openDownloadForCurrent(){
  const dl = partsDownloadLinks[idx] || '';
  if(!dl){ showToast('Tidak ada link download untuk bagian ini.'); return; }
  window.open(dl, '_blank', 'noopener');
}
dlBtn.addEventListener('click', openDownloadForCurrent);

/* Build parts grid */
function buildPartsGrid(){
  partsGrid.innerHTML = '';
  if(!partsDownloadLinks || !partsDownloadLinks.length){
    partsGrid.innerHTML = '<div style="color:var(--muted)">Tidak ada bagian.</div>';
    return;
  }
  partsDownloadLinks.forEach((link, i) => {
    const a = document.createElement('a');
    a.className = 'part-item';
    a.href = link;
    a.target = '_blank';
    a.rel = 'noopener noreferrer nofollow';
    a.innerHTML = `<span class="dot" aria-hidden="true"></span><span>Video ${i+1}</span>`;
    a.dataset.index = i;
    a.addEventListener('click', (e)=> {
      e.preventDefault();
      idx = clampIndex(Number(a.dataset.index));
      setSourceNoAuto(videos[idx]);
    });
    partsGrid.appendChild(a);
  });
  updatePartsHighlight();
  updatePartBadge();
}

function updatePartsHighlight(){
  const items = partsGrid.querySelectorAll('.part-item');
  items.forEach((el, i) => {
    if(i === idx) {
      el.classList.add('active');
      el.setAttribute('aria-current','true');
      try{ el.scrollIntoView({ block: 'nearest', inline: 'nearest', behavior: 'smooth' }); }catch(e){}
    } else {
      el.classList.remove('active');
      el.removeAttribute('aria-current');
    }
  });
}

function updatePartBadge(){
  const total = partsDownloadLinks.length || videos.length || 1;
  partBadge.textContent = `Video ${idx+1} / ${total}`;
}

function buildFullModal(){
  fullModalList.innerHTML = '';
  const list = [];
  if(downloads.uc) list.push({label:'UC Share', href: downloads.uc});
  if(downloads.terabox) list.push({label:'Terabox', href: downloads.terabox});
  if(!list.length){
    const p = document.createElement('div');
    p.className = 'modal-note';
    p.textContent = 'Tidak ada konten full tersedia.';
    fullModalList.appendChild(p);
    return;
  }
  list.forEach(item => {
    const wrap = document.createElement('div');
    wrap.className = 'modal-item';
    const a = document.createElement('a');
    a.href = item.href;
    a.target = '_blank';
    a.rel = 'noopener noreferrer nofollow';
    a.textContent = item.label;
    wrap.appendChild(a);
    fullModalList.appendChild(wrap);
  });
}

function openFullModal(){
  buildFullModal();
  fullModal.classList.add('show');
  fullModal.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';
  setTimeout(()=> {
    const first = fullModalList.querySelector('a');
    if(first) first.focus();
  }, 50);
}
function closeFullModal(){
  fullModal.classList.remove('show');
  fullModal.setAttribute('aria-hidden','true');
  document.body.style.overflow = '';
  fullActionBtn.focus();
}

fullActionBtn.addEventListener('click', (e) => { e.stopPropagation(); openFullModal(); });
fullModalClose.addEventListener('click', closeFullModal);
fullModal.addEventListener('click', (e) => { if(e.target === fullModal) closeFullModal(); });
window.addEventListener('keydown', (e) => { if(e.key === 'Escape' && fullModal.classList.contains('show')) closeFullModal(); });

/* Init */
buildPartsGrid();
updateCenterPlay();
(function initPlayIcon(){ playBtn.querySelector('svg').innerHTML = '<path d="M8 5v14l11-7z"/>'; })();
</script>
</body>
</html>
