<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Custom Video Player — Mobile (with state)</title>
<link rel="icon" href="favicon.ico">
<style>
:root{
  --bg:#0f0f0f;
  --panel:#181818;
  --border:#232323;
  --muted:#9ea8b4;
  --text:#ffffff;
  --accent:#ff0000;
  --accent-2:#3ea6ff;
  --control-h:56px;
  --round:10px;
}

/* Base */
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter, Roboto, Arial, sans-serif;-webkit-font-smoothing:antialiased}
a{color:inherit}
.wrap{max-width:980px;margin:0 auto;padding:0 12px}

/* Player card */
.card-player{margin-top:10px;border-radius:8px;overflow:hidden}
.video-area{position:relative;background:#000;border-radius:8px;overflow:hidden}
video{width:100%;height:auto;display:block;background:#000;object-fit:contain}

/* Center big play */
.center-play{
  position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
  width:68px;height:68px;border-radius:999px;display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.55);border:1px solid rgba(255,255,255,0.05);z-index:40;cursor:pointer;-webkit-tap-highlight-color:transparent;
}
.center-play svg{width:30px;height:30px;fill:var(--text)}

/* loading overlay */
.loading-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:45;pointer-events:none}
.loading-box{display:flex;gap:12px;align-items:center;padding:10px 12px;border-radius:12px;background:rgba(0,0,0,0.55);border:1px solid rgba(255,255,255,0.04)}
.loading-spinner{width:28px;height:28px;border-radius:50%;border:3px solid rgba(255,255,255,0.06);border-top-color:var(--accent);animation:spin .9s linear infinite}

/* meta */
.top-meta{padding:10px 6px;display:flex;align-items:center;gap:8px;justify-content:space-between}
.title-wrap{display:flex;flex-direction:column;gap:6px}
.title{font-size:16px;font-weight:700;margin:0;line-height:1.2}
.date{font-size:13px;color:var(--muted);margin-top:0}
.part-badge{font-size:13px;color:var(--text);background:rgba(255,255,255,0.04);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.03)}

/* controls */
.controls{background:var(--panel);border-top:1px solid var(--border);padding:10px 8px;display:flex;flex-direction:column;gap:8px;border-radius:0 0 8px 8px}
.seek-row{display:flex;align-items:center;gap:8px}
.time{width:54px;font-size:12px;color:var(--muted);text-align:center}
.seek{flex:1;-webkit-appearance:none;background:transparent;height:6px;position:relative}
.seek::-webkit-slider-runnable-track{height:6px;background:#333;border-radius:6px}
.seek::-webkit-slider-thumb{appearance:none;width:12px;height:12px;border-radius:50%;background:var(--accent);margin-top:-3px;box-shadow:0 0 0 6px rgba(255,0,0,0.06)}
.seek::-moz-range-track{height:6px;background:#333;border-radius:6px}
.seek::-moz-range-thumb{width:12px;height:12px;border-radius:50%;background:var(--accent)}

/* control row */
.control-row{display:flex;align-items:center;gap:8px;height:var(--control-h)}
.left{display:flex;align-items:center;gap:6px}
.right{margin-left:auto;display:flex;align-items:center;gap:6px}

/* buttons */
.btn{background:transparent;border:none;color:var(--text);padding:8px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
.btn:active{transform:scale(0.98)}
.btn svg{width:22px;height:22px;display:block;fill:var(--text)}
.btn-play{width:44px;height:44px;background:linear-gradient(90deg,var(--accent-2),var(--accent));border-radius:8px;display:flex;align-items:center;justify-content:center}
.btn-play svg{width:18px;height:18px;fill:#fff}

/* small select */
.select{background:transparent;border:1px solid var(--border);color:var(--text);padding:6px;border-radius:8px;font-size:13px}

/* downloads (section header renamed to "video player") */
.downloads{padding:10px 6px;background:var(--panel);border-top:1px solid var(--border)}
.heading{font-weight:700;margin-bottom:8px}
.download-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px}
.download-btn{display:inline-flex;align-items:center;gap:8px;padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text);font-weight:600;font-size:13px;text-decoration:none}

/* channel icons */
.channel-grid{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.channel-btn{width:44px;height:44px;border-radius:8px;background:transparent;border:1px solid var(--border);display:inline-flex;align-items:center;justify-content:center}

/* parts list (with active highlight) */
.parts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-top:8px}
.part-item{padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent;font-weight:600;color:var(--text);text-decoration:none;display:inline-flex;align-items:center;gap:8px}
.part-item.active{background:linear-gradient(90deg, rgba(62,166,255,0.08), rgba(255,0,0,0.06));border-color:rgba(62,166,255,0.18);box-shadow:0 6px 18px rgba(2,6,23,0.5)}
.part-item:focus{outline:2px solid rgba(62,166,255,0.14);outline-offset:2px}

/* toast */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(0,0,0,0.8);color:var(--text);padding:10px 14px;border-radius:10px;display:none;font-size:13px;z-index:60}

/* accessibility focus */
button:focus, .download-btn:focus, .part-item:focus, select:focus{outline:2px solid rgba(255,255,255,0.06);outline-offset:2px}

@media(min-width:720px){ .wrap{max-width:980px;padding:12px} video{max-height:60vh} }
@keyframes spin{ to { transform: rotate(360deg); } }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card-player" id="card">
      <div class="video-area" id="videoArea" aria-label="Video area">
        <video id="video" playsinline webkit-playsinline preload="metadata" tabindex="0"></video>

        <button id="centerPlay" class="center-play" aria-label="Play">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
        </button>

        <div id="loading" class="loading-overlay" style="display:none;pointer-events:none" aria-hidden="true">
          <div class="loading-box" role="status" aria-live="polite">
            <div class="loading-spinner" aria-hidden="true"></div>
            <div>
              <div style="font-weight:700;font-size:14px">Memuat video…</div>
              <div style="color:var(--muted);font-size:13px">Menunggu jaringan / buffering</div>
            </div>
          </div>
        </div>
      </div>

      <div class="top-meta">
        <div class="title-wrap">
          <div id="title" class="title">Judul Video</div>
          <div id="date" class="date"></div>
        </div>
        <div id="partBadge" class="part-badge" aria-live="polite">Part 1 / 1</div>
      </div>

      <div class="controls" role="region" aria-label="Kontrol pemutar">
        <div class="seek-row">
          <div id="current" class="time">0:00</div>
          <input id="seek" class="seek" type="range" min="0" max="100" step="0.01" value="0" aria-label="Seek bar">
          <div id="duration" class="time">0:00</div>
        </div>

        <div class="control-row" aria-hidden="false">
          <div class="left" role="group" aria-label="Main controls">
            <button id="prev" class="btn" title="Previous" aria-label="Previous">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 6h2v12H6zm3 6l9 6V6z"/></svg>
            </button>

            <button id="play" class="btn-play" title="Play/Pause" aria-label="Play/Pause">
              <svg id="playIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
            </button>

            <button id="next" class="btn" title="Next" aria-label="Next">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 6h2v12h-2zM6 18l9-6-9-6z"/></svg>
            </button>

            <button id="loop" class="btn" title="Loop" aria-pressed="false" aria-label="Loop">Loop</button>

            <button id="dl" class="btn" title="Download" aria-label="Download">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 16l4-5h-3V4h-2v7H8zM4 18h16v2H4z"/></svg>
            </button>
          </div>

          <div class="right">
            <select id="speed" class="select" aria-label="Playback speed">
              <option value="0.5">0.5x</option>
              <option value="0.75">0.75x</option>
              <option value="1" selected>1x</option>
              <option value="1.25">1.25x</option>
              <option value="1.5">1.5x</option>
              <option value="2">2x</option>
            </select>

            <button id="pip" class="btn" title="Picture-in-Picture" aria-label="Picture in picture">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M19 7H5v10h14V7zm0-2a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h14zM7 9h6v4H7z"/></svg>
            </button>

            <button id="fs" class="btn" title="Fullscreen" aria-label="Fullscreen">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 14H5v5h5v-2H7zm0-4h2V7h3V5H5v5zm10 9h-3v2h5v-5h-2zm-3-14v2h3v3h2V5z"/></svg>
            </button>
          </div>
        </div>
      </div>

      <div class="downloads" aria-label="video player">
        <div class="heading">video player</div>
        <div id="downloadButtons" class="download-grid"></div>

        <div style="margin-top:12px;font-weight:700">video player (download link sudah ada di tombol unduh)</div>
        <div id="partsGrid" class="parts-grid"></div>

        <div class="channel-grid" style="margin-top:12px">
          <a class="channel-btn" id="ucBtn" target="_blank" rel="noopener noreferrer nofollow" title="UC Share" aria-label="UC Share" href="#">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path d="M12 2a5 5 0 00-5 5v1H5v5h2v6h10v-6h2V8h-2V7a5 5 0 00-5-5z"/></svg>
          </a>
          <a class="channel-btn" id="tbBtn" target="_blank" rel="noopener noreferrer nofollow" title="Terabox" aria-label="Terabox" href="#">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path d="M3 3h18v18H3z"/></svg>
          </a>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ===== DATA (sama seperti sebelumnya) ===== */
const videos = [
  "https://cdn.vipoy.co/videos/cmkunk30a01mzseksx2oy19il/1769445408126-1000098857.mp4",
  "https://cdn.vipoy.co/videos/cmkunk30a01mzseksx2oy19il/1769445041400-1000099491.mp4",
  "https://cdn.vipoy.co/videos/cmkunk30a01mzseksx2oy19il/1769445587141-1000098654.mp4",
  "https://cdn.vipoy.co/videos/cmkunk30a01mzseksx2oy19il/1769445543114-1000098660.mp4",
  "https://cdn.vipoy.co/videos/cmkunk30a01mzseksx2oy19il/1769445467259-1000098667.mp4",
  "https://cdn.vipoy.co/videos/cmkunk30a01mzseksx2oy19il/1769445293226-1000099080.mp4",
  "https://cdn.vipoy.co/videos/cmkunk30a01mz30a01mzseksx2oy19il/1769445230849-1000099292.mp4",
  "https://cdn.vipoy.co/videos/cmkunk30a01mzseksx2oy19il/1769445208260-1000099332.mp4",
  "https://cdn.vipoy.co/videos/cmkunk30a01mzseksx2oy19il/1769445122943-1000099386.mp4"
];

const partsDownloadLinks = [
  "https://vipoy.co/view/k10pepch",
  "https://vipoy.co/view/czu1oxm1",
  "https://vipoy.co/view/a2h5t352",
  "https://vipoy.co/view/1fs8ojba",
  "https://vipoy.co/view/nfda2171",
  "https://vipoy.co/view/12eo8y55",
  "https://vipoy.co/view/uoqmpjnh",
  "https://vipoy.co/view/tdykl7x6",
  "https://vipoy.co/view/phslcvzl"
];

const downloads = {
  uc: "https://uc-share.com/s/c274d9a2762f4?la=en-us",
  terabox: "https://1024terabox.com/s/1gcGs04775L7mTUFhQ1_RWw"
};

/* ===== DOM refs (keep IDs same) ===== */
const video = document.getElementById('video');
const centerPlay = document.getElementById('centerPlay');
const loading = document.getElementById('loading');
const playBtn = document.getElementById('play');
const prevBtn = document.getElementById('prev');
const nextBtn = document.getElementById('next');
const loopBtn = document.getElementById('loop');
const dlBtn = document.getElementById('dl');
const speedSel = document.getElementById('speed');
const seek = document.getElementById('seek');
const currentT = document.getElementById('current');
const durationT = document.getElementById('duration');
const titleEl = document.getElementById('title');
const downloadsWrap = document.getElementById('downloadButtons');
const partsGrid = document.getElementById('partsGrid');
const toast = document.getElementById('toast');
const ucBtn = document.getElementById('ucBtn');
const tbBtn = document.getElementById('tbBtn');
const pipBtn = document.getElementById('pip');
const fsBtn = document.getElementById('fs');
const partBadge = document.getElementById('partBadge');

let idx = 0;
let isSeeking = false;

/* state key */
const STORAGE_KEY = 'custom_video_player_state_v1';
let savedState = null;
let lastSaveAt = 0;

/* ===== Utility helpers (same behavior) ===== */
function fmt(s){ if(!isFinite(s)) return "0:00"; const sec = Math.floor(s%60).toString().padStart(2,'0'); const min = Math.floor(s/60); return `${min}:${sec}`; }
function showLoading(){ loading.style.display = ''; loading.setAttribute('aria-hidden','false'); }
function hideLoading(){ loading.style.display = 'none'; loading.setAttribute('aria-hidden','true'); updateCenterPlay(); }
function showToast(msg, time = 3200){ toast.textContent = msg; toast.style.display = 'block'; setTimeout(()=> toast.style.display = 'none', time); }

function clampIndex(i){ if(!videos.length) return 0; return ((i % videos.length) + videos.length) % videos.length; }

/* ===== Persistence: load saved state (idx + time) ===== */
function loadSavedState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(typeof obj === 'object' && Number.isFinite(obj.idx)) return obj;
    return null;
  }catch(e){
    return null;
  }
}

function saveStateImmediate(){
  try{
    const state = { idx: idx, time: Math.floor(video.currentTime || 0) };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    lastSaveAt = Date.now();
  }catch(e){}
}

/* save periodically (throttled) */
function saveStateThrottled(){
  const now = Date.now();
  if(now - lastSaveAt > 2000){ saveStateImmediate(); }
}

/* ===== Core functions (preserve names) ===== */
function setSourceNoAuto(src){
  try{ video.pause(); }catch(e){}
  video.removeAttribute('src');
  video.src = src;
  try{ video.load(); }catch(e){}
  showLoading();
  // update UI badge and highlight
  updatePartBadge();
  updatePartsHighlight();
  // save idx change immediately
  saveStateImmediate();
}

/* determine starting index from saved state */
savedState = loadSavedState();
if(savedState && Number.isFinite(savedState.idx) && savedState.idx >= 0 && savedState.idx < videos.length){
  idx = clampIndex(savedState.idx);
} else {
  idx = 0;
}

/* init first source (may be overridden by saved time on loadedmetadata) */
if(videos.length) setSourceNoAuto(videos[idx]);

/* Events: metadata / canplay / playing / waiting / timeupdate similar to old logic */
video.addEventListener('loadedmetadata', () => {
  durationT.textContent = fmt(video.duration || 0);
  seek.max = video.duration || 100;

  // If savedState matches current idx, restore time (if valid)
  try{
    const s = loadSavedState();
    if(s && Number.isFinite(s.idx) && s.idx === idx && Number.isFinite(s.time) && s.time > 0 && s.time < (video.duration - 0.5)){
      // set currentTime after a short delay to avoid DOM issues
      setTimeout(()=> { try{ video.currentTime = Number(s.time); }catch(e){} }, 50);
    }
  }catch(e){}
});

video.addEventListener('canplay', () => { hideLoading(); });

video.addEventListener('playing', () => {
  hideLoading();
  // change play icon to pause
  playBtn.querySelector('svg').innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
  centerPlay.style.display = 'none';
});

['waiting','stalled'].forEach(ev => video.addEventListener(ev, () => { showLoading(); }));

video.addEventListener('timeupdate', () => {
  if(!isSeeking){ seek.value = video.currentTime; currentT.textContent = fmt(video.currentTime); }
  // throttle save
  saveStateThrottled();
});

/* seek interactions */
seek.addEventListener('input', ()=> { isSeeking = true; currentT.textContent = fmt(seek.value); });
seek.addEventListener('change', ()=> { video.currentTime = Number(seek.value); isSeeking = false; });

/* togglePlay (preserve semantics) */
async function togglePlay(){
  try {
    if(video.paused){
      await video.play();
      playBtn.querySelector('svg').innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'; // pause icon
      centerPlay.style.display = 'none';
    } else {
      video.pause();
      playBtn.querySelector('svg').innerHTML = '<path d="M8 5v14l11-7z"/>'; // play icon
      centerPlay.style.display = '';
    }
  } catch(e){
    showToast('Gagal memutar. Coba klik lagi.');
    console.warn('Play failed', e);
  }
}

/* wire UI - keep same listeners as before but mapped to custom controls */
playBtn.addEventListener('click', togglePlay);
centerPlay.addEventListener('click', (e)=>{ e.stopPropagation(); togglePlay(); });
video.addEventListener('click', togglePlay);

/* pause event restore center play */
video.addEventListener('pause', ()=> { playBtn.querySelector('svg').innerHTML = '<path d="M8 5v14l11-7z"/>'; centerPlay.style.display = ''; });

function updateCenterPlay(){ centerPlay.style.display = video.paused ? '' : 'none'; }

/* Prev / Next: same logic (no autoplay) */
prevBtn.addEventListener('click', ()=> {
  if(!videos.length){ showToast('Tidak ada bagian tersisa.'); return; }
  idx = clampIndex(idx - 1);
  setSourceNoAuto(videos[idx]);
});
nextBtn.addEventListener('click', ()=> {
  if(!videos.length){ showToast('Tidak ada bagian tersisa.'); return; }
  idx = clampIndex(idx + 1);
  setSourceNoAuto(videos[idx]);
});

/* Loop toggle */
loopBtn.addEventListener('click', ()=> {
  video.loop = !video.loop;
  loopBtn.setAttribute('aria-pressed', String(video.loop));
  loopBtn.classList.toggle('active', video.loop);
});

/* Speed control (still same) */
speedSel.addEventListener('change', ()=> { video.playbackRate = Number(speedSel.value); });

/* Fullscreen */
fsBtn.addEventListener('click', ()=> {
  const el = document.querySelector('.video-area');
  if(!document.fullscreenElement) el.requestFullscreen().catch(()=>{});
  else document.exitFullscreen();
});

/* Picture-in-picture */
pipBtn.addEventListener('click', async ()=>{
  if('pictureInPictureEnabled' in document){
    try{
      if(document.pictureInPictureElement) await document.exitPictureInPicture();
      else await video.requestPictureInPicture();
    }catch(e){ console.warn('PIP failed', e); }
  }
});

/* Auto-next on ended (no autoplay) */
video.addEventListener('ended', ()=> {
  if(videos.length && idx < videos.length - 1){ idx++; setSourceNoAuto(videos[idx]); }
});

/* Error handling: identical to previous logic */
video.addEventListener('error', (e) => {
  const failedSrc = video.currentSrc || video.src || 'unknown';
  console.warn('Video error at index', idx, failedSrc, e);
  hideLoading();

  const pos = videos.indexOf(failedSrc);
  if(pos !== -1){
    videos.splice(pos,1);
    if(partsDownloadLinks[pos]) partsDownloadLinks.splice(pos,1);
    showToast('Bagian ' + (pos+1) + ' gagal dimuat — dihapus.');
    if(pos <= idx) idx = Math.max(0, idx - 1);
  } else {
    showToast('Sumber gagal dimuat.');
  }

  if(videos.length){
    idx = clampIndex(idx);
    setTimeout(()=> setSourceNoAuto(videos[idx]), 250);
    buildPartsGrid();
  } else {
    showToast('Semua sumber gagal.');
    try{ video.removeAttribute('src'); video.load(); }catch(e){}
    buildPartsGrid();
  }
});

/* Keyboard shortcuts (preserve) */
window.addEventListener('keydown', (e)=> {
  if(['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
  if(e.code === 'Space'){ e.preventDefault(); togglePlay(); }
  if(e.code === 'ArrowLeft'){ video.currentTime = Math.max(0, video.currentTime - 5); }
  if(e.code === 'ArrowRight'){ video.currentTime = Math.min(video.duration || 0, video.currentTime + 5); }
  if(e.key === 'm'){ video.muted = !video.muted; }
});

/* Block right-click */
document.addEventListener('contextmenu', e => e.preventDefault());

/* DOWNLOAD ACTIONS: open mapped download URL for current part */
function openDownloadForCurrent(){
  const dl = partsDownloadLinks[idx] || '';
  if(!dl){ showToast('Tidak ada link download untuk bagian ini.'); return; }
  window.open(dl, '_blank', 'noopener');
}
dlBtn.addEventListener('click', openDownloadForCurrent);

/* Build Full konten area (UC & Terabox) - same as before */
function buildDownloadButtons(){
  downloadsWrap.innerHTML = '';
  if(downloads.uc){
    const a = document.createElement('a');
    a.className = 'download-btn';
    a.href = downloads.uc;
    a.target = '_blank';
    a.rel = 'noopener noreferrer nofollow';
    a.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path d="M12 2a5 5 0 00-5 5v1H5v5h2v6h10v-6h2V8h-2V7a5 5 0 00-5-5z"/></svg><span style="margin-left:6px">UC Share — Full konten</span>';
    downloadsWrap.appendChild(a);
    ucBtn.href = downloads.uc;
  }
  if(downloads.terabox){
    const a = document.createElement('a');
    a.className = 'download-btn';
    a.href = downloads.terabox;
    a.target = '_blank';
    a.rel = 'noopener noreferrer nofollow';
    a.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path d="M3 3h18v18H3z"/></svg><span style="margin-left:6px">Terabox — Full konten</span>';
    downloadsWrap.appendChild(a);
    tbBtn.href = downloads.terabox;
  }
  if(!downloads.uc && !downloads.terabox){
    downloadsWrap.innerHTML = '<div style="color:var(--muted)">Tidak ada full-link.</div>';
  }
}

/* Build parts grid (links ordered) with active highlight */
function buildPartsGrid(){
  partsGrid.innerHTML = '';
  if(!partsDownloadLinks || !partsDownloadLinks.length){
    partsGrid.innerHTML = '<div style="color:var(--muted)">Tidak ada bagian.</div>';
    return;
  }
  partsDownloadLinks.forEach((link, i) => {
    const a = document.createElement('a');
    a.className = 'part-item';
    a.href = link;
    a.target = '_blank';
    a.rel = 'noopener noreferrer nofollow';
    a.innerText = 'Part ' + (i+1);
    a.dataset.index = i;
    a.addEventListener('click', (e)=> {
      e.preventDefault();
      idx = clampIndex(Number(a.dataset.index));
      setSourceNoAuto(videos[idx]);
    });
    partsGrid.appendChild(a);
  });
  updatePartsHighlight();
  updatePartBadge();
}

/* highlight active part in UI */
function updatePartsHighlight(){
  const items = partsGrid.querySelectorAll('.part-item');
  items.forEach((el, i) => {
    if(i === idx) {
      el.classList.add('active');
      el.setAttribute('aria-current','true');
      // keep visible for users
      el.scrollIntoView({ block: 'nearest', inline: 'nearest', behavior: 'smooth' });
    } else {
      el.classList.remove('active');
      el.removeAttribute('aria-current');
    }
  });
}

/* update badge near title */
function updatePartBadge(){
  const total = partsDownloadLinks.length || videos.length || 1;
  partBadge.textContent = `Part ${idx+1} / ${total}`;
}

/* Init UI */
buildDownloadButtons();
buildPartsGrid();
updateCenterPlay();

/* Save state on unload */
window.addEventListener('beforeunload', ()=> {
  saveStateImmediate();
});

/* expose for external use if needed */
window.setSourceNoAuto = setSourceNoAuto;

(function initPlayIcon(){
  playBtn.querySelector('svg').innerHTML = '<path d="M8 5v14l11-7z"/>';
})();
</script>
</body>
</html>
